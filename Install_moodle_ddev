#!/bin/bash

#######################################################
# Moodle Installation Script for DDEV
# This script installs Moodle LMS in a DDEV environment
# Features: Resumable, idempotent, checks existing components
#######################################################

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration variables
MOODLE_VERSION="MOODLE_404_STABLE"  # Change this to desired version
PROJECT_NAME="moodle"  # DDEV project name
PROJECT_DIR="$HOME/moodle-project"  # Change this to your preferred location
MOODLE_DIR="$PROJECT_DIR"
DB_NAME="db"  # DDEV default database name
DB_USER="db"  # DDEV default user
DB_PASS="db"  # DDEV default password
DB_HOST="db"  # DDEV database host

# Checkpoint file to track progress
CHECKPOINT_FILE="$PROJECT_DIR/.moodle_install_progress.txt"
CREDENTIALS_FILE="$PROJECT_DIR/INSTALLATION_NOTES.txt"

echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}Moodle Installation Script for DDEV${NC}"
echo -e "${GREEN}Resumable & Idempotent Version${NC}"
echo -e "${GREEN}========================================${NC}"

# Function to mark a step as complete
mark_complete() {
    echo "$1=done" >> "$CHECKPOINT_FILE"
    eval "$1=done"
}

# Function to check if a step is complete
is_complete() {
    grep -q "^$1=done$" "$CHECKPOINT_FILE" 2>/dev/null
    return $?
}

# Function to handle errors
handle_error() {
    echo -e "${RED}========================================${NC}"
    echo -e "${RED}Error occurred in step: $1${NC}"
    echo -e "${RED}========================================${NC}"
    echo -e "${YELLOW}The script can be safely re-run to resume from this point.${NC}"
    echo -e "${YELLOW}Progress has been saved to: $CHECKPOINT_FILE${NC}"
    exit 1
}

# Step 1: Check for Docker
if ! is_complete "STEP_DOCKER_CHECK"; then
    echo -e "${YELLOW}Step 1: Checking for Docker...${NC}"
    
    if command -v docker &> /dev/null; then
        echo -e "${GREEN}  ✓ Docker is installed${NC}"
        
        # Check if Docker daemon is running
        if docker info &> /dev/null; then
            echo -e "${GREEN}  ✓ Docker daemon is running${NC}"
        else
            echo -e "${RED}  ✗ Docker daemon is not running${NC}"
            echo -e "${YELLOW}  → Please start Docker and run this script again${NC}"
            handle_error "Docker Daemon Not Running"
        fi
        
        mark_complete "STEP_DOCKER_CHECK"
    else
        echo -e "${RED}  ✗ Docker is not installed${NC}"
        echo -e "${YELLOW}  → Installing Docker...${NC}"
        
        # Install Docker based on OS
        if [[ "$OSTYPE" == "linux-gnu"* ]]; then
            curl -fsSL https://get.docker.com -o get-docker.sh
            if sudo sh get-docker.sh; then
                sudo usermod -aG docker $USER
                echo -e "${GREEN}  ✓ Docker installed successfully${NC}"
                echo -e "${YELLOW}  → Please log out and back in for group changes to take effect${NC}"
                echo -e "${YELLOW}  → Then run this script again${NC}"
                rm get-docker.sh
                exit 0
            else
                handle_error "Docker Installation"
            fi
        else
            echo -e "${RED}Please install Docker Desktop from https://www.docker.com/products/docker-desktop${NC}"
            handle_error "Docker Not Installed"
        fi
    fi
else
    echo -e "${GREEN}✓ Step 1: Docker already checked (skipping)${NC}"
fi

# Step 2: Check for DDEV
if ! is_complete "STEP_DDEV_CHECK"; then
    echo -e "${YELLOW}Step 2: Checking for DDEV...${NC}"
    
    if command -v ddev &> /dev/null; then
        DDEV_VERSION=$(ddev version | head -n1)
        echo -e "${GREEN}  ✓ DDEV is installed: $DDEV_VERSION${NC}"
        mark_complete "STEP_DDEV_CHECK"
    else
        echo -e "${RED}  ✗ DDEV is not installed${NC}"
        echo -e "${YELLOW}  → Installing DDEV...${NC}"
        
        # Install DDEV based on OS
        if [[ "$OSTYPE" == "linux-gnu"* ]]; then
            curl -fsSL https://raw.githubusercontent.com/ddev/ddev/master/scripts/install_ddev.sh | bash
            
            if command -v ddev &> /dev/null; then
                echo -e "${GREEN}  ✓ DDEV installed successfully${NC}"
                mark_complete "STEP_DDEV_CHECK"
            else
                handle_error "DDEV Installation"
            fi
        elif [[ "$OSTYPE" == "darwin"* ]]; then
            if command -v brew &> /dev/null; then
                brew install ddev/ddev/ddev
                mark_complete "STEP_DDEV_CHECK"
            else
                echo -e "${RED}Homebrew not found. Please install from https://brew.sh${NC}"
                handle_error "Homebrew Not Found"
            fi
        else
            echo -e "${RED}Please install DDEV from https://ddev.readthedocs.io/en/stable/users/install/ddev-installation/${NC}"
            handle_error "DDEV Not Installed"
        fi
    fi
else
    echo -e "${GREEN}✓ Step 2: DDEV already checked (skipping)${NC}"
fi

# Step 3: Create project directory
if ! is_complete "STEP_PROJECT_DIR"; then
    echo -e "${YELLOW}Step 3: Creating project directory...${NC}"
    
    if [ -d "$PROJECT_DIR" ]; then
        echo -e "${BLUE}  ✓ Project directory already exists: $PROJECT_DIR${NC}"
        
        # Check if it's a git repository with Moodle
        if [ -d "$PROJECT_DIR/.git" ] && [ -f "$PROJECT_DIR/version.php" ]; then
            echo -e "${BLUE}  ✓ Valid Moodle installation detected${NC}"
            mark_complete "STEP_PROJECT_DIR"
            mark_complete "STEP_MOODLE_DOWNLOAD"
        else
            echo -e "${YELLOW}  → Directory exists but doesn't contain Moodle${NC}"
        fi
        
        # Initialize checkpoint file in existing directory
        touch "$CHECKPOINT_FILE"
        mark_complete "STEP_PROJECT_DIR"
    else
        if mkdir -p "$PROJECT_DIR"; then
            cd "$PROJECT_DIR"
            touch "$CHECKPOINT_FILE"
            echo -e "${GREEN}  ✓ Created project directory: $PROJECT_DIR${NC}"
            mark_complete "STEP_PROJECT_DIR"
        else
            handle_error "Project Directory Creation"
        fi
    fi
else
    echo -e "${GREEN}✓ Step 3: Project directory already exists (skipping)${NC}"
fi

# Change to project directory
cd "$PROJECT_DIR" || handle_error "Cannot access project directory"

# Step 4: Download Moodle
if ! is_complete "STEP_MOODLE_DOWNLOAD"; then
    echo -e "${YELLOW}Step 4: Downloading Moodle...${NC}"
    
    if [ -f "version.php" ]; then
        echo -e "${BLUE}  ✓ Moodle files already present${NC}"
        mark_complete "STEP_MOODLE_DOWNLOAD"
    else
        # Check if directory is empty (except for hidden files and checkpoint)
        if [ "$(ls -A | grep -v '^\.' | grep -v 'INSTALLATION_NOTES.txt' | wc -l)" -gt 0 ]; then
            echo -e "${YELLOW}  → Directory not empty. Creating moodle subdirectory...${NC}"
            
            if git clone -b $MOODLE_VERSION --depth 1 https://github.com/moodle/moodle.git temp_moodle; then
                # Move contents up one level
                mv temp_moodle/* temp_moodle/.git* . 2>/dev/null
                rmdir temp_moodle
                echo -e "${GREEN}  ✓ Moodle downloaded successfully${NC}"
                mark_complete "STEP_MOODLE_DOWNLOAD"
            else
                handle_error "Moodle Download"
            fi
        else
            if git clone -b $MOODLE_VERSION --depth 1 https://github.com/moodle/moodle.git .; then
                echo -e "${GREEN}  ✓ Moodle downloaded successfully${NC}"
                mark_complete "STEP_MOODLE_DOWNLOAD"
            else
                handle_error "Moodle Download"
            fi
        fi
    fi
else
    echo -e "${GREEN}✓ Step 4: Moodle already downloaded (skipping)${NC}"
fi

# Step 5: Configure DDEV
if ! is_complete "STEP_DDEV_CONFIG"; then
    echo -e "${YELLOW}Step 5: Configuring DDEV...${NC}"
    
    if [ -f ".ddev/config.yaml" ]; then
        echo -e "${BLUE}  ✓ DDEV configuration already exists${NC}"
        echo -e "${YELLOW}  → Checking if we need to update it...${NC}"
    fi
    
    # Configure DDEV for Moodle
    if ddev config --project-type=php --php-version=8.1 --docroot="" --create-docroot=false --project-name="$PROJECT_NAME"; then
        echo -e "${GREEN}  ✓ DDEV configured for Moodle${NC}"
        
        # Create custom nginx configuration for Moodle
        mkdir -p .ddev/nginx
        cat > .ddev/nginx/moodle.conf << 'NGINXEOF'
# Moodle-specific nginx configuration

client_max_body_size 256M;

location / {
    try_files $uri $uri/ /index.php?$args;
}

location ~ [^/]\.php(/|$) {
    fastcgi_split_path_info ^(.+\.php)(/.+)$;
    fastcgi_index index.php;
    fastcgi_pass unix:/run/php-fpm.sock;
    include fastcgi_params;
    fastcgi_param PATH_INFO $fastcgi_path_info;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_buffer_size 128k;
    fastcgi_buffers 256 16k;
    fastcgi_busy_buffers_size 256k;
    fastcgi_temp_file_write_size 256k;
    fastcgi_read_timeout 300;
}

location /dataroot/ {
    internal;
    alias /var/www/html/moodledata/;
}
NGINXEOF
        echo -e "${GREEN}  ✓ Custom nginx configuration created${NC}"
        
        # Create PHP configuration for Moodle
        mkdir -p .ddev/php
        cat > .ddev/php/moodle.ini << 'PHPEOF'
upload_max_filesize = 256M
post_max_size = 256M
memory_limit = 512M
max_execution_time = 300
max_input_time = 300
max_input_vars = 5000
PHPEOF
        echo -e "${GREEN}  ✓ PHP configuration created${NC}"
        
        mark_complete "STEP_DDEV_CONFIG"
    else
        handle_error "DDEV Configuration"
    fi
else
    echo -e "${GREEN}✓ Step 5: DDEV already configured (skipping)${NC}"
fi

# Step 6: Start DDEV
if ! is_complete "STEP_DDEV_START"; then
    echo -e "${YELLOW}Step 6: Starting DDEV...${NC}"
    
    if ddev start; then
        echo -e "${GREEN}  ✓ DDEV started successfully${NC}"
        mark_complete "STEP_DDEV_START"
    else
        handle_error "DDEV Start"
    fi
else
    echo -e "${GREEN}✓ Step 6: DDEV already started${NC}"
    
    # Check if DDEV is running
    if ! ddev describe &> /dev/null; then
        echo -e "${YELLOW}  → DDEV not running, starting it...${NC}"
        ddev start
    fi
fi

# Step 7: Create moodledata directory
if ! is_complete "STEP_MOODLEDATA"; then
    echo -e "${YELLOW}Step 7: Creating moodledata directory...${NC}"
    
    if ddev exec "mkdir -p /var/www/html/moodledata && chmod 777 /var/www/html/moodledata"; then
        echo -e "${GREEN}  ✓ Moodledata directory created${NC}"
        mark_complete "STEP_MOODLEDATA"
    else
        handle_error "Moodledata Creation"
    fi
else
    echo -e "${GREEN}✓ Step 7: Moodledata already exists (skipping)${NC}"
fi

# Step 8: Create config.php
if ! is_complete "STEP_CONFIG_PHP"; then
    echo -e "${YELLOW}Step 8: Creating Moodle configuration...${NC}"
    
    # Get DDEV URLs
    DDEV_URL=$(ddev describe -j | grep -o '"url":"[^"]*"' | head -1 | cut -d'"' -f4)
    
    if [ -f "config.php" ]; then
        echo -e "${BLUE}  ✓ config.php already exists, backing up...${NC}"
        mv config.php "config.php.backup.$(date +%Y%m%d_%H%M%S)"
    fi
    
    cat > config.php << 'CONFIGEOF'
<?php  // Moodle configuration file

unset($CFG);
global $CFG;
$CFG = new stdClass();

$CFG->dbtype    = 'mariadb';
$CFG->dblibrary = 'native';
$CFG->dbhost    = 'db';
$CFG->dbname    = 'db';
$CFG->dbuser    = 'db';
$CFG->dbpass    = 'db';
$CFG->prefix    = 'mdl_';
$CFG->dboptions = array (
  'dbpersist' => 0,
  'dbport' => 3306,
  'dbsocket' => '',
  'dbcollation' => 'utf8mb4_unicode_ci',
);

$CFG->wwwroot   = 'DDEV_URL_PLACEHOLDER';
$CFG->dataroot  = '/var/www/html/moodledata';
$CFG->admin     = 'admin';

$CFG->directorypermissions = 0777;

require_once(__DIR__ . '/lib/setup.php');

// There is no php closing tag in this file,
// it is intentional because it prevents trailing whitespace problems!
CONFIGEOF
    
    # Replace placeholder
    sed -i "s|DDEV_URL_PLACEHOLDER|$DDEV_URL|g" config.php
    
    echo -e "${GREEN}  ✓ Moodle configuration created${NC}"
    mark_complete "STEP_CONFIG_PHP"
else
    echo -e "${GREEN}✓ Step 8: config.php already exists (skipping)${NC}"
fi

# Step 9: Install Moodle via CLI (optional - can also use web installer)
if ! is_complete "STEP_MOODLE_INSTALL"; then
    echo -e "${YELLOW}Step 9: Would you like to install Moodle via CLI now? (y/n)${NC}"
    echo -e "${BLUE}  (You can also complete installation via web interface later)${NC}"
    read -p "Install now? (y/n): " -n 1 -r
    echo
    
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${YELLOW}  → Installing Moodle via CLI...${NC}"
        
        read -p "Enter admin username (default: admin): " ADMIN_USER
        ADMIN_USER=${ADMIN_USER:-admin}
        
        read -p "Enter admin email: " ADMIN_EMAIL
        while [ -z "$ADMIN_EMAIL" ]; do
            read -p "Admin email is required: " ADMIN_EMAIL
        done
        
        read -s -p "Enter admin password (min 8 chars): " ADMIN_PASS
        echo
        while [ ${#ADMIN_PASS} -lt 8 ]; do
            read -s -p "Password must be at least 8 characters: " ADMIN_PASS
            echo
        done
        
        read -p "Enter site full name (default: Moodle Site): " SITE_FULLNAME
        SITE_FULLNAME=${SITE_FULLNAME:-"Moodle Site"}
        
        read -p "Enter site short name (default: Moodle): " SITE_SHORTNAME
        SITE_SHORTNAME=${SITE_SHORTNAME:-"Moodle"}
        
        if ddev exec php admin/cli/install_database.php \
            --agree-license \
            --adminuser="$ADMIN_USER" \
            --adminpass="$ADMIN_PASS" \
            --adminemail="$ADMIN_EMAIL" \
            --fullname="$SITE_FULLNAME" \
            --shortname="$SITE_SHORTNAME"; then
            
            echo -e "${GREEN}  ✓ Moodle installed successfully via CLI${NC}"
            
            # Save admin credentials
            echo "ADMIN_USER=$ADMIN_USER" >> "$CHECKPOINT_FILE"
            echo "ADMIN_EMAIL=$ADMIN_EMAIL" >> "$CHECKPOINT_FILE"
            
            mark_complete "STEP_MOODLE_INSTALL"
        else
            echo -e "${RED}  ✗ CLI installation failed${NC}"
            echo -e "${YELLOW}  → You can complete installation via web interface${NC}"
        fi
    else
        echo -e "${YELLOW}  → Skipping CLI installation. Use web installer instead.${NC}"
        mark_complete "STEP_MOODLE_INSTALL"
    fi
else
    echo -e "${GREEN}✓ Step 9: Moodle installation already completed (skipping)${NC}"
fi

# Step 10: Save installation notes
if ! is_complete "STEP_SAVE_NOTES"; then
    echo -e "${YELLOW}Step 10: Saving installation notes...${NC}"
    
    DDEV_URL=$(ddev describe -j | grep -o '"url":"[^"]*"' | head -1 | cut -d'"' -f4)
    
    # Load admin credentials if they exist
    ADMIN_USER=$(grep "^ADMIN_USER=" "$CHECKPOINT_FILE" 2>/dev/null | cut -d'=' -f2)
    ADMIN_EMAIL=$(grep "^ADMIN_EMAIL=" "$CHECKPOINT_FILE" 2>/dev/null | cut -d'=' -f2)
    
    cat > "$CREDENTIALS_FILE" << EOF
========================================
Moodle DDEV Installation Notes
========================================
Installation Date: $(date)
Project Name: $PROJECT_NAME
Project Directory: $PROJECT_DIR
Moodle Version: $MOODLE_VERSION

DDEV URLs:
---------
Web: $DDEV_URL
PHPMyAdmin: ${DDEV_URL%/}:8036

Database Credentials:
-------------------
Host: db (inside container)
Database: db
Username: db
Password: db

Moodle Admin:
------------
$(if [ -n "$ADMIN_USER" ]; then
    echo "Username: $ADMIN_USER"
    echo "Email: $ADMIN_EMAIL"
else
    echo "Complete setup via web interface: $DDEV_URL"
fi)

Useful DDEV Commands:
-------------------
ddev start              - Start the project
ddev stop               - Stop the project
ddev restart            - Restart the project
ddev ssh                - SSH into web container
ddev logs               - View logs
ddev describe           - Show project details
ddev sequelpro          - Open database in SequelPro (Mac)
ddev launch             - Open site in browser
ddev exec <command>     - Run command in container

Moodle CLI Commands (from project root):
---------------------------------------
ddev exec php admin/cli/upgrade.php             - Run upgrades
ddev exec php admin/cli/maintenance.php --enable - Enable maintenance mode
ddev exec php admin/cli/cron.php                - Run cron

Project Files:
-------------
Moodle Config: $PROJECT_DIR/config.php
Moodle Data: /var/www/html/moodledata (inside container)
DDEV Config: $PROJECT_DIR/.ddev/config.yaml
Progress: $CHECKPOINT_FILE

To Reset Installation:
--------------------
1. Stop DDEV: ddev stop
2. Remove database: ddev delete -O
3. Delete checkpoint: rm $CHECKPOINT_FILE
4. Run script again

Troubleshooting:
--------------
- View web logs: ddev logs
- Check PHP errors: ddev exec tail -f /var/log/php/*.log
- Restart services: ddev restart
- Clear cache: ddev exec php admin/cli/purge_caches.php

========================================
EOF
    
    chmod 600 "$CREDENTIALS_FILE"
    mark_complete "STEP_SAVE_NOTES"
    echo -e "${GREEN}  ✓ Installation notes saved${NC}"
else
    echo -e "${GREEN}✓ Step 10: Installation notes already saved (skipping)${NC}"
fi

# Final summary
echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}Installation Complete!${NC}"
echo -e "${GREEN}========================================${NC}"
echo ""
echo -e "${YELLOW}Your Moodle site is ready!${NC}"
echo ""
echo -e "${BLUE}Access your site:${NC}"

DDEV_URL=$(ddev describe -j | grep -o '"url":"[^"]*"' | head -1 | cut -d'"' -f4)
echo -e "  Web: ${GREEN}$DDEV_URL${NC}"
echo -e "  PHPMyAdmin: ${GREEN}${DDEV_URL%/}:8036${NC}"
echo ""
echo -e "${BLUE}Quick commands:${NC}"
echo "  Open in browser:  ${GREEN}ddev launch${NC}"
echo "  View logs:        ${GREEN}ddev logs${NC}"
echo "  SSH to container: ${GREEN}ddev ssh${NC}"
echo "  Stop DDEV:        ${GREEN}ddev stop${NC}"
echo ""
echo -e "${YELLOW}Installation notes saved to:${NC}"
echo "  ${GREEN}$CREDENTIALS_FILE${NC}"
echo ""
echo -e "${YELLOW}Project directory:${NC}"
echo "  ${GREEN}$PROJECT_DIR${NC}"
echo ""
echo -e "${BLUE}Next steps:${NC}"

if is_complete "STEP_MOODLE_INSTALL" && [ -n "$(grep '^ADMIN_USER=' $CHECKPOINT_FILE 2>/dev/null)" ]; then
    echo "1. Visit $DDEV_URL and log in"
    echo "2. Start customizing your Moodle site"
else
    echo "1. Visit $DDEV_URL to complete web-based installation"
    echo "2. Follow the installation wizard"
fi

echo "3. Configure cron: Add to crontab or use 'ddev exec php admin/cli/cron.php'"
echo ""
echo -e "${GREEN}Completed steps:${NC} $(grep '=done' "$CHECKPOINT_FILE" | wc -l)/10"
echo ""
echo -e "${GREEN}========================================${NC}"
